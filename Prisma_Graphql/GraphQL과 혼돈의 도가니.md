

<GraphQL과 혼돈의 도가니>

이번에 인스타그램 클론 코딩을 하면서 Rest API를 쓰지않고 PRISMA를 이용해보았다.

GraphQL로 모델링으로 하고 resolver를 만들어 쿼리 요청시 해당 데이터를 가공해 반환하는 형식이다. 

이번에 seeFeed라는 쿼리를 만들어서 내가 팔로우 중인 유저의 포스트들을 모두 가져오는 기능을 리졸버에 구현했다.

그리고 해당 모델링에는 필수로 값이 들어가야 한다고 명시해 두었다. 

Ex ) 
type Query{
    seeFeed:[Post!]!
}

그런데 자신있게 seeFeed 쿼리를 날렸더니 Cannot return null for non-nullable field Post.user 라는 에러가 발생하는 것이다. 

당황해서 한 시도는 다음과 같다

1. 데이터베이스의 Post 테이블에 유저 정보가 들어있지 않은지 확인
  -> 유저 정보 있다.

2. 모델링 한 부분에서 Post의 요소중 user를 필수 입력으로 한 걸 빼봄
  -> 진짜 user가 null로 넘어오네?

3. Post의 resolver를 확인. 프리즈마 쿼리를 이용해서 user 쿼리 요청시 해당 id의 Post를 조회해서 user를 찾는 걸 확인
  -> 이쯤되니 뭐지. 모든 것이 완벽한데.. 싶었다.

하지만 계속 서버에선 "마! null반환 안한다고 해놓고 왜 null반환하고 있는데!" 를 외치는 상황...

하염없이 리졸버에서 무엇이 문젠지 찾던 도중 진짜.. 진짜 멍청한 버그를 발견했다.


user: ({ id }, _, { prisma }) => {
	prisma.post({ id }).user()
}


뭐가 문제인지 알겠는가?


바로 return이 빠진것이다..........

아 당연히 실컷 조회하고 return 안해주면 return null 하겠지......


난 이날 분노와 환희를 동시에 느꼈다. 나는 멍청이.... 

Graphql로선 일 잘했는데 (너 null 허용 안한다매!! 지금 null이잖아 라고 말해줬으니..) 기껏 리졸버에서 리턴을 안해준 격이다.

이로써 나는 뻐그는 진짜 사소한 곳에서 나온다는 걸 다시금 깨달았다.

흑흑



